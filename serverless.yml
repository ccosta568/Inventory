service: author-inventory

# frameworkVersion: '3'

custom:
  serverless-offline:
    httpPort: 3002
  stage: ${opt:stage, self:provider.stage}
  exportBucketName: author-inventory-exports-${sls:stage}
  siteBucketName: author-inventory-site-${sls:stage}
  cognitoDomainPrefix: author-inventory-${sls:stage}
  serverlessPluginTypescript:
    tsConfigFileLocation: backend/tsconfig.json

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'us-east-1'}
  profile: personal
  stage: ${opt:stage, 'dev'}
  environment:
    TABLE_NAME:
      Ref: InventoryTable
    EXPORT_BUCKET_NAME:
      Ref: InventoryExportBucket
    ALLOW_DEV_AUTH: ${env:ALLOW_DEV_AUTH, 'true'}
    DEV_AUTH_USER: ${env:DEV_AUTH_USER, 'dev-user'}
  httpApi:
    cors:
      allowedOrigins:
        - 'http://localhost:4200'
      allowedMethods:
        - GET
        - POST
        - PUT
        - OPTIONS
      allowedHeaders:
        - Content-Type
        - x-dev-user
      exposeHeaders: []
      maxAge: 86400
     # Temporarily disable Cognito authorizer while we just test the API
    # authorizers:
    #   cognitoAuthorizer:
    #     type: jwt
    #     identitySource: '$request.header.Authorization'
    #     issuer:
    #       Fn::Join:
    #         - ''
    #         - - 'https://cognito-idp.'
    #           - ${self:provider.region}
    #           - '.amazonaws.com/'
    #           - { Ref: CognitoUserPool }
    #     audience:
    #       - { Ref: CognitoUserPoolClient }

plugins:
  - serverless-plugin-typescript
  - serverless-offline

functions:
  books:
    handler: backend/src/handlers/books.handler
    role: BooksLambdaRole
    events:
      - httpApi:
          path: /books
          method: get
      - httpApi:
          path: /books
          method: post
      - httpApi:
          path: /books/{id}
          method: put
      - httpApi:
          path: /books/{id}/adjust-stock
          method: post

  events:
    handler: backend/src/handlers/events.handler
    role: EventsLambdaRole
    events:
      - httpApi:
          path: /events
          method: get
      - httpApi:
          path: /events/{id}
          method: get
      - httpApi:
          path: /events
          method: post
      - httpApi:
          path: /events/{id}/apply
          method: post

  nightlyExport:
    handler: backend/src/handlers/exporter.handler
    role: ExporterLambdaRole
    events:
      - schedule: cron(0 7 * * ? *)

resources:
  Resources:
    InventoryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: author-inventory-data-${sls:stage}
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST

    InventoryExportBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.exportBucketName}
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: PurgeOldExports
              Status: Enabled
              ExpirationInDays: 30

    StaticSiteBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.siteBucketName}
        AccessControl: Private
        VersioningConfiguration:
          Status: Enabled

    SiteOriginAccessIdentity:
      Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
      Properties:
        CloudFrontOriginAccessIdentityConfig:
          Comment: Access identity for static site bucket

    StaticSiteBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: { Ref: StaticSiteBucket }
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                AWS:
                  Fn::Join:
                    - ''
                    - - 'arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity '
                      - { Ref: SiteOriginAccessIdentity }
              Action: 's3:GetObject'
              Resource:
                - Fn::Join:
                    - ''
                    - - 'arn:aws:s3:::'
                      - { Ref: StaticSiteBucket }
                      - '/*'

    SiteDistribution:
      Type: AWS::CloudFront::Distribution
      Properties:
        DistributionConfig:
          Enabled: true
          DefaultRootObject: index.html
          PriceClass: PriceClass_100
          Origins:
            - Id: StaticSiteOrigin
              DomainName:
                Fn::GetAtt:
                  - StaticSiteBucket
                  - RegionalDomainName
              S3OriginConfig:
                OriginAccessIdentity:
                  Fn::Join:
                    - ''
                    - - 'origin-access-identity/cloudfront/'
                      - { Ref: SiteOriginAccessIdentity }
          DefaultCacheBehavior:
            TargetOriginId: StaticSiteOrigin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods:
              - GET
              - HEAD
              - OPTIONS
            CachedMethods:
              - GET
              - HEAD
            ForwardedValues:
              QueryString: false
              Cookies:
                Forward: none

    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: author-inventory-${sls:stage}
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: false

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: author-inventory-client-${sls:stage}
        GenerateSecret: false
        UserPoolId: { Ref: CognitoUserPool }
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
        # Remove these lines:
        # AllowedOAuthFlowsUserPoolClient: true
        # AllowedOAuthFlows:
        #   - password
        # AllowedOAuthScopes:
        #   - email
        #   - openid
        RefreshTokenValidity: 30

    CognitoUserPoolDomain:
      Type: AWS::Cognito::UserPoolDomain
      Properties:
        Domain: ${self:custom.cognitoDomainPrefix}
        UserPoolId: { Ref: CognitoUserPool }

    BooksLambdaRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: author-inventory-books-${sls:stage}
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: books-lambda-policy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource: '*'
                - Effect: Allow
                  Action:
                    - dynamodb:GetItem
                    - dynamodb:PutItem
                    - dynamodb:UpdateItem
                    - dynamodb:Query
                  Resource:
                    - { 'Fn::GetAtt': ['InventoryTable', 'Arn'] }
                    - Fn::Join:
                        - ''
                        - - { 'Fn::GetAtt': ['InventoryTable', 'Arn'] }
                          - '/index/GSI1'

    EventsLambdaRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: author-inventory-events-${sls:stage}
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: events-lambda-policy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource: '*'
                - Effect: Allow
                  Action:
                    - dynamodb:GetItem
                    - dynamodb:PutItem
                    - dynamodb:UpdateItem
                    - dynamodb:Query
                    - dynamodb:BatchWriteItem
                  Resource:
                    - { 'Fn::GetAtt': ['InventoryTable', 'Arn'] }
                    - Fn::Join:
                        - ''
                        - - { 'Fn::GetAtt': ['InventoryTable', 'Arn'] }
                          - '/index/GSI1'

    ExporterLambdaRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: author-inventory-exporter-${sls:stage}
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: exporter-lambda-policy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - logs:CreateLogGroup
                    - logs:CreateLogStream
                    - logs:PutLogEvents
                  Resource: '*'
                - Effect: Allow
                  Action:
                    - dynamodb:Scan
                  Resource:
                    - { 'Fn::GetAtt': ['InventoryTable', 'Arn'] }
                - Effect: Allow
                  Action:
                    - s3:PutObject
                  Resource:
                    - Fn::Join:
                        - ''
                        - - 'arn:aws:s3:::'
                          - { Ref: InventoryExportBucket }
                          - '/*'

  Outputs:
    InventoryTableName:
      Value: { Ref: InventoryTable }
    ExportBucketName:
      Value: { Ref: InventoryExportBucket }
    SiteBucketName:
      Value: { Ref: StaticSiteBucket }
    SiteDistributionDomain:
      Value:
        Fn::GetAtt:
          - SiteDistribution
          - DomainName
    CognitoUserPoolId:
      Value: { Ref: CognitoUserPool }
    CognitoUserPoolClientId:
      Value: { Ref: CognitoUserPoolClient }
    CognitoDomainPrefix:
      Value: ${self:custom.cognitoDomainPrefix}
